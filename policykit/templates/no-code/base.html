{% extends "./nocode_base.html" %}
{% load static %}

{% block styles %}
<style>
  html {
    font-size: 100%;     /* 16px */
  }

  body {
    font-family: 'Arial', sans-serif;
    font-weight: 400;
    font-size: 16px;
    line-height: 24px;
    color: #111;
  }

  p {
    margin: 0;
  }

  h1, h2, h3, h4, h5 {
    font-weight: 400;
    margin: 0;
  }

  h1,
  .heading-1 {
    margin-top: 0;
    font-size: 39.81px;
    line-height: 24px;
  }

  h2,
  .heading-2 {
    font-size: 33.18px;
    margin: 0 0 36px 0;
    text-align: center;
    font-weight: 600;
  }

  h3,
  .heading-3 {
    font-size: 27.65px;
    text-align: center;
  }

  h4,
  .heading-4 {
    font-size: 23.04px;
    line-height: 28px;
    text-align: center;
  }

  h5,
  .heading-5 {
    font-size: 19.20px;
    color: #666;
  }

  small,
  .text-small {
    font-size: 13.33px;
  }

  .large {
    font-family: 'Nunito';
    font-style: normal;
    font-size: 19px;
  }

  .medium {
    font-family: 'Nunito';
    font-style: normal;
    font-size: 16px;
  }
  
  .small {
    font-family: 'Nunito';
    font-style: normal;
    font-size: 14px;
  }

  .normal {
    color: #3A3A3A;
  }
  .prompt {
    color: #52677A;
    font-weight: 300;
  }

  .info {
    color: #4451B2;
  }


  .container {
    display: flex;
    margin-left: 0;
    margin-right: 0;
    max-width: 100%;

  }

  .wizard {
    padding: 24px 16px 32px;
    flex-basis: 0;
    flex-grow: 1;
  }

  /*For the overall panel layout 3:7 */
  .nocode-container {
    display: flex;
    width: 100%;
    
  }
  .nocode-sidebar {
    flex-basis: 30%;
  }

  .nocode-panel {
    flex-basis: 70%;
    height: 100%;
    background-color: #F8F9FA;

    display: flex;
    flex-direction: column;
  }

  /*for the slider panel that pops up when selecting actions or procedures*/
  #slider-panel {
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: center;
    gap: 32px;
    padding: 32px;
    
    background: #FFFFFF;
    border-right: 1px solid #F1F4F6;
    box-shadow: 0px 20px 20px rgba(0, 0, 0, 0.08);
  }

  #slider-panel.hidden {
    display: none;
  }

  .slide-panel-header {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 0px;
    gap: 24px;

    align-self: stretch;
  }

  .slide-panel-body {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 0px;
    gap: 32px;

    align-self: stretch;
  }


  /* for the main panel */
  .panel-header {

  }

  .panel-body { /* for the list of sections */
    overflow-y: auto;
    flex-grow: 1;
    
    display: flex;
    flex-direction: column;
    align-items: stretch;
    padding: 0px 10% 116px;
    gap: 16px;
  }

  .panel-bottom { /* for the bottom buttons */
    align-self: flex-end;
    padding-left: 10%;
    padding-right: 10%;
  }

  /* for each section in the main panel */
  .panel-body section {
    border-radius: 10px;
    background-color: white;
    padding: 16px 0px;
    flex-basis: 100%;
    
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    align-items: flex-start;
    gap: 16px;
  }

  .section-header {
    font-size: 23.04px;
    line-height: 28px;
    text-align: center;
    padding: 0px 32px 8px;
  }

  .section-body.active {
    display: flex;
    flex-direction: column;
    align-items: flex-start;

    padding: 0px 32px;
    gap: 16px;
    background: #FFFFFF;
    align-self: stretch;
  }

  .section-body.inactive {    
    display: flex;
    flex-direction: row;
    justify-content: center;
    align-items: center;
    align-self: stretch;
    padding: 16px 32px;
    gap: 8px;

    height: 100px;
  }

  .section-inactive-button {
    align-self: stretch;
    flex-grow: 1;

    background: #F8F9FA;
    border-radius: 8px;
    border: none;
  }

  /*for the actions list in the slider panel*/
  .actions-checkbox-section {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 0px;
    gap: 16px;

    align-self: stretch;
  }

  .actions-checkbox-header {
    border-bottom: 1px solid #F3F5F7;
    align-self: stretch;
  }

  .action-checkbox-body {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 0px 0px 8px;
    gap: 8px;

    align-self: stretch;
  }

  .actions-checkbox-item {
    display: flex;
    flex-direction: row;
    align-items: baseline;
    padding: 8px;
    gap: 16px;
  }

  .actions-checkbox-input {
    flex-grow: 0;
    border: 1px solid #4451B2;
    border-radius: 2px;
  }

  .actions-checkbox-label{
    flex-grow: 0;
  }














  .description {
    margin: 0 0 32px;
  }
  
  .selectpicker-group {
      display: flex;
      justify-content: center;
      line-height: 50px;
  }

  .selectpicker-group label {
      margin-right: 10px;
  }

  .action-picker div {
      margin: 0px 0px 10px 24px;
  }

  /*For the blocks of action filters*/
  .custom-action-group {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 0px 16px;
    gap: 16px;
    
    border: 1px solid #F3F5F7;
    border-radius: 8px;
    align-self: stretch;
  }

  .custom-action-label {
    font-weight: 500;
  }

  .custom-action-field {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 0px 16px;
    gap: 10px;

    align-self: stretch;
  }

  .variable-item {
    display: flex;
    flex-direction: row;
    justify-content: flex-start;
    align-items: center;
    padding: 0px;
    gap: 8px;
  }

  .variable-item label {
    font-weight: 500;
    font-size: 14px;
    flex-basis:  30%;
    flex-grow: 1;
  }

  .variable-item.selectpicker-wrapper {
    flex-basis: 70%;
    flex-grow: 1;

  }

  .selectpicker {
    border: 1px solid #ced4da;
    border-radius: .25rem;
    background-color: #ffffff;
  }

  .selectpicker + button.btn.dropdown-toggle,
  .selectpicker + button.btn.dropdown-toggle.disabled {
    border: 1px solid #ced4da;
    border-radius: .25rem;
    background-color: #ffffff;
  }

  .selectpicker + button {
    border: 1px solid #ced4da;
    border-radius: .25rem;
    background-color: #ffffff;
  }


  #module-picker option {
    width: fit-content;
  }
  .action-label {
    font-weight: 500;
    font-size: 19px;
  }
  .variables {
        margin: 0 0 24px;
        justify-content: center;
        align-items: center;
    }

  .variable-values {
      margin: 5px 0 4px 0;
      justify-content: center;
      align-items: center;

  }

  .variable-label {
      margin: 2px 6px 4px 2px;
  }

  .variable-prompt {
      font-size: 10px;
      color: #bbb;
  }

  input
  .variable-input {
      padding: 8px;
      border: 1px solid #bbb;
      border-radius: 4px;
      width: 300px;
  }

  .button-group {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
  }

  .button {
      border: none;
      padding: 12px;
      cursor: pointer;
      border-radius: 16px;
  }

  .secondary {
      background: transparent;
      border: 1px solid #bbb;
      margin: 0 10px 0 0;
  }

  .secondary:hover {
      background: #eee;
  }

  .primary {
      background: #444;
      color: #fff;
  }

  .primary:hover {
      background: #000;
  }


</style>
{% endblock %}

{% block content %}
<div class="container">
  <div class="wizard">
    {% csrf_token %}
    {% block step %}
    {% endblock %}
{% endblock %}

{% block scripts %}
<script>
  // ids for UI sections
  const stepElementIds = {
    policytype: 'choose_policy_type',
    custom_action: 'design_custom_action',
    procedure: 'design_procedure',
    customize: "customize_procedure",
    execution: 'design_execution',
    overview: 'policy_overview',
  }

  // Reference of class names defined here to avoid repetition
  const classnames = {
    visible: 'active',
    primary: 'primary',
    secondary: 'secondary'
  }

  const getVariableDataInStep = (elementId, elements=null) => {
        // Select all input elements in step element
        var inputElements;
        if(elementId){
          inputElements = document.getElementById(elementId).querySelectorAll('.variable-input');
        } else {
          inputElements = elements.querySelectorAll('.variable-input');
        }

        var variable_data = {};
        
        Array.from(inputElements).forEach(input => {
          // if it is an input element
          if(input.tagName === 'INPUT'){
            let value = input.value;
            /* 
              the display of a input box that shows a date and time is for the conveience of the user,
              while in the backend we still use timestamp. 
              Therefore, the conversation of the value is more of the task of the frontend. 
              In contrast, we store a list of numbers still as strings in the backend, 
              and the backend should take care of the conversion of such values
            */
            if(input.type === 'datetime-local'){
              const dateObject = new Date(value);
              value = Math.floor(dateObject.getTime() / 1000)
            }
            variable_data[input.getAttribute('data-id')] = value;
          }
          else if(input.tagName === 'SELECT'){
            let selected_options = Array.from(input.selectedOptions).map(({ value }) => value).join(",");
            variable_data[input.getAttribute('data-id')] = selected_options;
          }
        });
        return variable_data;
  }

  const checkMissingVariable = (elementId, elements=null) => {
    var inputElements;
    if(elementId){
      inputElements = document.getElementById(elementId).querySelectorAll('.variable-input');
    } else {
      inputElements = elements.querySelectorAll('.variable-input');
    } 
    
    var missing_variables = false;
    Array.from(inputElements).forEach(input => {
        // if it is an input box
      if(input.tagName === 'INPUT') {
        if(!input.reportValidity()){
          missing_variables = true;
          input.style.border = '1px solid red';
        } else {
          input.style.border = '1px solid #bbb';
        }
      } else if(input.tagName === 'SELECT' && input.required){
        // if it is a select-picker object, it is actually an select element enclosed by a div
        let selected_options = Array.from(input.selectedOptions).map(({ value }) => value).join(",")
        if(selected_options === ""){
          missing_variables = true;
          input.parentElement.style.border = '1px solid red';
        } else {
          input.parentElement.style.border = '1px solid rgb(187, 187, 187)';
        }
      }
    });
    return missing_variables;
  }
  // Redirect to another step page
  const redirect = (pageKey, urlParams = {}) => {
    // URLs for the different step pages
    const pages = {
      policytype: '/no-code/policytype',
      custom_action: '/no-code/custom_action',
      procedure: '/no-code/design_procedure',
      customize: '/no-code/customize_procedure',
      execution: '/no-code/design_execution',
      overview: '/no-code/policy_overview',
      details: '/main/editor/'
    }

    if (!pages[pageKey]) return

    const url = pages[pageKey]

    const searchParams = Object.keys(urlParams).length > 0
      ? '?' + Object.keys(urlParams).map(key => `${key}=${urlParams[key]}`).join('&')
      : ''

    window.location.href = `${pages[pageKey]}${searchParams}`
  }

  const submit = async (url, submitData) => {
    // Django generated csrf token
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value

    try {
      const response = await fetch(`${url}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(submitData)
      })

      if (!response.ok) {
        const text = await response.text()

        console.error(text)
      }

      const json = await response.json()
      return json
    } catch (e) {
      console.log(e)
    }
  }

  const removeElementChildren = (element_id) => {
      var element = document.getElementById(element_id);
      var docstyle = element.style.display;
      if (docstyle == 'none') element.style.display = '';
      element.replaceChildren();
  }

  const addVariableInputBox = (variable, id, parentDiv, options=null, datalist=null) => {
      var text = document.createElement('div');
      text.classList.add('variable');
      text.id = id;

      var input_validate = "";
      if(variable["is_required"] ?? true){
            input_validate += " required";
      }

      var prompt = "";
      if(Boolean(variable["prompt"]) == true)
      // if it is not empty, null, or undefined
      prompt = `<p class='variable-prompt text-small'>${variable.prompt}</p>`;

      if(options && variable["entity"] && (variable["entity"] in options)){
        // if it is, then we use a select as the input box
        if(variable["is_list"] ?? false){
          input_validate += "  multiple";
        }
        let innerHTML = `<div class='variable-values'>
                            <label class='variable-label' for='${id}'>${variable.label}</label>
                            <select class='variable-input selectpicker' data-id='${id}' title="Select an ${variable.label}" ${input_validate}>`;
        
        options[variable["entity"]].forEach(entity => {
          innerHTML += `<option value='${entity.value}'>${entity.name}</option>`;
        });
        innerHTML += `</select>${prompt}</div>`;
        text.innerHTML = innerHTML;
        
      } else {
        // figure out what type of input requirement is needed
        if(variable["is_list"] ?? false){
            if(variable["type"] === "string")
              input_validate += '  pattern="^[a-zA-Z0-9]+(,\\s*[a-zA-Z0-9]+)*$" title="Please enter comma separated strings" type="text"';
            else if(variable["type"] === "number")
              input_validate += '  pattern="^\\d+(,\\s*\\d+)*$" title="Please enter comma separated numbers" type="text"';
            else if(variable["type"] === "float")
              input_validate += '  pattern="^([-+]?[0-9]*\\.?[0-9]+)(,\\s*[-+]?[0-9]*\\.?[0-9]+)*$" title="Please enter comma separated floats" type="text"';
            else if(variable["type"] === "timestamp")
              console.warn("We do not support a variable as a list of timestamps yet");
        } else {
            if(variable["type"] === "string")
              input_validate += ' type="text"';
            else if(variable["type"] === "number")
              input_validate += ' type="number"';
            else if(variable["type"] === "float")
              input_validate += ' type="number" step="0.01"';
            else if(variable["type"] === "timestamp")
              input_validate += ' type="datetime-local"';
        }

        if(variable["default_value"])
          // if it is a select input, then a default value is actually not much needed
            input_validate += `  value='${variable.default_value}'`;
        if(datalist){
          // if there is a datalist, then we need to add the datalist to the parent div
          text.innerHTML = `<div class='variable-values'>
                            <label class='variable-label' for='${id}'>${variable.label}</label>
                            <input class='variable-input' data-id='${id}' ${input_validate} list="variable-options"/>
                            ${prompt}
                            ${datalist}
                        </div>`;
        } else {
          text.innerHTML = `<div class='variable-values'>
                              <label class='variable-label' for='${id}'>${variable.label}</label>
                              <input class='variable-input' data-id='${id}' ${input_validate}/>
                              ${prompt}
                          </div>`;
        }
      }
      parentDiv.appendChild(text);
      $(".selectpicker").selectpicker("refresh");
      
  }
</script>
{% endblock %}

{% block step_scripts %}
{% endblock %}